/**
 *************************************************************************************
 * @file	ai_resample.c
 * @author	Owen
 * @version	v1.0.0
 * @date    2019/07/10
 * @brief	Sample rate convert  only for 44100 to 8000
 * Copyright (C) Shanghai Mountain View Silicon Technology Co.,Ltd. All rights reserved.
 *************************************************************************************
 */

#include <string.h>
#include "type.h"
#include "debug.h"



#define BL 1001
#define RESAMPLE_COUNT	80
#define FILTER_COEF_CNT	 ((BL - 1)/RESAMPLE_COUNT)
typedef struct _SRC_INFO
{
	int16_t FilterBuf[/*441 + (FILTER_COEF_CNT)+1*/882];
	uint32_t  InCnt;
	uint32_t  OutCnt;
	uint32_t  BufCnt;
} SRC_INFO;
SRC_INFO SrcInfo;

const uint16_t src_in_offset[80]={
0,6,12,17,23,28,34,39,45,50,56,61,67,72,78,83,89,94,100,
105,111,116,122,127,133,138,144,149,155,160,166,171,177,
182,188,193,199,204,210,215,221,227,232,238,243,249,254,
260,265,271,276,282,287,293,298,304,309,315,320,326,331,
337,342,348,353,359,364,370,375,381,386,392,397,403,408,
414,419,425,430,436
};

const int16_t filter_coef[RESAMPLE_COUNT][FILTER_COEF_CNT] = {
{0, -1, -2, 8, 74, 205, 306, 269, 135, 32, -1, -2},
{0, -2, -1, 31, 133, 267, 307, 207, 75, 9, -2, -1},
{-1, -2, 8, 72, 202, 305, 271, 139, 33, -1, -2, 0},
{0, -2, -1, 29, 130, 265, 307, 211, 78, 10, -2, -1},
{-1, -2, 7, 69, 198, 304, 274, 142, 35, 0, -2, 0},
{0, -1, -1, 28, 127, 262, 308, 214, 81, 10, -2, -1},
{-1, -2, 6, 66, 195, 303, 276, 145, 37, 0, -2, 0},
{0, -1, -1, 26, 123, 259, 309, 218, 84, 11, -2, -1},
{0, -2, 6, 64, 191, 301, 279, 149, 39, 0, -2, 0},
{0, -1, -2, 25, 120, 256, 310, 221, 86, 12, -2, -1},
{0, -2, 5, 62, 188, 300, 281, 152, 40, 1, -2, 0},
{0, -1, -2, 24, 117, 253, 310, 224, 89, 13, -2, -1},
{0, -2, 5, 59, 184, 298, 283, 156, 42, 1, -2, 0},
{0, -1, -2, 22, 114, 250, 310, 228, 92, 14, -2, -1},
{0, -2, 4, 57, 181, 297, 285, 159, 44, 1, -2, 0},
{0, -1, -2, 21, 110, 247, 311, 231, 95, 15, -2, -1},
{0, -2, 3, 55, 177, 295, 288, 163, 46, 2, -2, 0},
{0, -1, -2, 20, 107, 244, 311, 234, 98, 16, -2, -1},
{0, -2, 3, 53, 174, 293, 290, 166, 48, 2, -2, 0},
{0, -1, -2, 19, 104, 241, 311, 238, 101, 17, -2, -1},
{0, -2, 3, 50, 170, 292, 292, 170, 50, 3, -2, 0},
{0, -1, -2, 17, 101, 238, 311, 241, 104, 19, -2, -1},
{0, -2, 2, 48, 166, 290, 293, 174, 53, 3, -2, 0},
{0, -1, -2, 16, 98, 234, 311, 244, 107, 20, -2, -1},
{0, -2, 2, 46, 163, 288, 295, 177, 55, 3, -2, 0},
{0, -1, -2, 15, 95, 231, 311, 247, 110, 21, -2, -1},
{0, -2, 1, 44, 159, 285, 297, 181, 57, 4, -2, 0},
{0, -1, -2, 14, 92, 228, 310, 250, 114, 22, -2, -1},
{0, -2, 1, 42, 156, 283, 298, 184, 59, 5, -2, 0},
{0, -1, -2, 13, 89, 224, 310, 253, 117, 24, -2, -1},
{0, -2, 1, 40, 152, 281, 300, 188, 62, 5, -2, 0},
{0, -1, -2, 12, 86, 221, 310, 256, 120, 25, -2, -1},
{0, -2, 0, 39, 149, 279, 301, 191, 64, 6, -2, 0},
{0, -1, -2, 11, 84, 218, 309, 259, 123, 26, -1, -1},
{0, -2, 0, 37, 145, 276, 303, 195, 66, 6, -2, -1},
{0, -1, -2, 10, 81, 214, 308, 262, 127, 28, -1, -1},
{0, -2, 0, 35, 142, 274, 304, 198, 69, 7, -2, -1},
{0, -1, -2, 10, 78, 211, 307, 265, 130, 29, -1, -2},
{0, -2, -1, 33, 139, 271, 305, 202, 72, 8, -2, -1},
{0, -1, -2, 9, 75, 207, 307, 267, 133, 31, -1, -2},
{0, -2, -1, 32, 135, 269, 306, 205, 74, 8, -2, -1},
{-1, -2, 8, 73, 204, 306, 270, 137, 33, -1, -2, 0},
{0, -2, -1, 30, 132, 266, 307, 209, 77, 9, -2, -1},
{-1, -2, 7, 70, 200, 305, 272, 140, 34, 0, -2, 0},
{0, -1, -1, 29, 128, 263, 308, 212, 79, 10, -2, -1},
{-1, -2, 7, 68, 197, 303, 275, 144, 36, 0, -2, 0},
{0, -1, -1, 27, 125, 260, 309, 216, 82, 11, -2, -1},
{0, -2, 6, 65, 193, 302, 277, 147, 38, 0, -2, 0},
{0, -1, -1, 26, 122, 257, 309, 219, 85, 12, -2, -1},
{0, -2, 5, 63, 190, 301, 280, 151, 39, 0, -2, 0},
{0, -1, -2, 24, 118, 255, 310, 223, 88, 13, -2, -1},
{0, -2, 5, 60, 186, 299, 282, 154, 41, 1, -2, 0},
{0, -1, -2, 23, 115, 252, 310, 226, 91, 14, -2, -1},
{0, -2, 4, 58, 182, 298, 284, 158, 43, 1, -2, 0},
{0, -1, -2, 22, 112, 249, 311, 229, 94, 15, -2, -1},
{0, -2, 4, 56, 179, 296, 286, 161, 45, 1, -2, 0},
{0, -1, -2, 20, 109, 245, 311, 233, 97, 16, -2, -1},
{0, -2, 3, 54, 175, 294, 289, 165, 47, 2, -2, 0},
{0, -1, -2, 19, 106, 242, 311, 236, 100, 17, -2, -1},
{0, -2, 3, 51, 172, 292, 291, 168, 49, 2, -2, 0},
{0, -1, -2, 18, 103, 239, 311, 239, 103, 18, -2, -1},
{0, -2, 2, 49, 168, 291, 292, 172, 51, 3, -2, 0},
{0, -1, -2, 17, 100, 236, 311, 242, 106, 19, -2, -1},
{0, -2, 2, 47, 165, 289, 294, 175, 54, 3, -2, 0},
{0, -1, -2, 16, 97, 233, 311, 245, 109, 20, -2, -1},
{0, -2, 1, 45, 161, 286, 296, 179, 56, 4, -2, 0},
{0, -1, -2, 15, 94, 229, 311, 249, 112, 22, -2, -1},
{0, -2, 1, 43, 158, 284, 298, 182, 58, 4, -2, 0},
{0, -1, -2, 14, 91, 226, 310, 252, 115, 23, -2, -1},
{0, -2, 1, 41, 154, 282, 299, 186, 60, 5, -2, 0},
{0, -1, -2, 13, 88, 223, 310, 255, 118, 24, -2, -1},
{0, -2, 0, 39, 151, 280, 301, 190, 63, 5, -2, 0},
{0, -1, -2, 12, 85, 219, 309, 257, 122, 26, -1, -1},
{0, -2, 0, 38, 147, 277, 302, 193, 65, 6, -2, 0},
{0, -1, -2, 11, 82, 216, 309, 260, 125, 27, -1, -1},
{0, -2, 0, 36, 144, 275, 303, 197, 68, 7, -2, -1},
{0, -1, -2, 10, 79, 212, 308, 263, 128, 29, -1, -1},
{0, -2, 0, 34, 140, 272, 305, 200, 70, 7, -2, -1},
{0, -1, -2, 9, 77, 209, 307, 266, 132, 30, -1, -2},
{0, -2, -1, 33, 137, 270, 306, 204, 73, 8, -2, -1}
};

static void sample_rate_convert(int16_t* x1, int16_t* y)
{
	uint32_t i;
	uint32_t j;
	for (i = 0; i < SrcInfo.OutCnt; i++)
	{
		int16_t const* a = filter_coef[i];
		int16_t* x = x1 + src_in_offset[i];
		int sum = 0;
		for (j = 0; j < FILTER_COEF_CNT; j++)
		{
			sum += a[j] * x[j];
		}
		y[i] = sum >> 10;
	}
}

uint16_t ai_resample_applay(int16_t* pcm_in, int16_t* pcm_out, uint16_t in_samples)
{
	uint32_t InCnt = SrcInfo.InCnt;
	uint32_t OutCnt = SrcInfo.OutCnt;
	int16_t* x = SrcInfo.FilterBuf;
	int16_t* y = pcm_out;
	uint32_t BufCnt = SrcInfo.BufCnt;
	int32_t Cnt = 0;
	int32_t n;

	n = (InCnt - (BufCnt % InCnt)) % InCnt;
	if (in_samples < n + FILTER_COEF_CNT)
	{
		memcpy(&x[BufCnt], pcm_in, in_samples * 2);
		BufCnt += in_samples;

		while (BufCnt >= InCnt + FILTER_COEF_CNT)
		{
			sample_rate_convert(x, y);
			x += InCnt;
			y += OutCnt;
			BufCnt -= InCnt;
			Cnt += OutCnt;
		}
		memcpy(SrcInfo.FilterBuf, x, BufCnt * 2);
		SrcInfo.BufCnt = BufCnt;
		return Cnt;
	}
	else
	{
		memcpy(&x[BufCnt], pcm_in, (n + FILTER_COEF_CNT) * 2);
		in_samples -= n;
		pcm_in += n;
		BufCnt += n;

		while (BufCnt >= InCnt)
		{
			sample_rate_convert(x, y);
			x += InCnt;
			y += OutCnt;
			BufCnt -= InCnt;
			Cnt += OutCnt;
		}
		x = pcm_in;
		while (in_samples >= InCnt + FILTER_COEF_CNT)
		{
			sample_rate_convert(x, y);
			x += InCnt;
			y += OutCnt;
			in_samples -= InCnt;
			Cnt += OutCnt;
		}
		memcpy(SrcInfo.FilterBuf, x, in_samples * 2);
		SrcInfo.BufCnt = in_samples;
		return Cnt;
	}
}

void ai_resample_init(void)
{
	memset(&SrcInfo, 0, sizeof(SrcInfo));
	SrcInfo.InCnt = 441;
	SrcInfo.OutCnt = 80;
}


